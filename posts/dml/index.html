<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-11-23">
<meta name="description" content="Obtain valid inferential statements about a low-dimensional parameter (ATE/LATE) in the presence of potentially high-dimensional confounding using modern ML methods.">

<title>Snippets of Things - Double/Debiased Machine Learning for Treatment and Structural Parameters</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../media/_favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Snippets of Things</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://dmolitor.com">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dmolitor/blog"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#packages" id="toc-packages" class="nav-link active" data-scroll-target="#packages">Packages</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#estimating-the-ate-of-401k-eligibility-on-net-financial-assets" id="toc-estimating-the-ate-of-401k-eligibility-on-net-financial-assets" class="nav-link" data-scroll-target="#estimating-the-ate-of-401k-eligibility-on-net-financial-assets">Estimating the ATE of 401(k) Eligibility on Net Financial Assets</a>
  <ul class="collapse">
  <li><a href="#partially-linear-regression-model" id="toc-partially-linear-regression-model" class="nav-link" data-scroll-target="#partially-linear-regression-model">Partially Linear Regression Model</a></li>
  <li><a href="#interactive-regression-model" id="toc-interactive-regression-model" class="nav-link" data-scroll-target="#interactive-regression-model">Interactive Regression Model</a></li>
  </ul></li>
  <li><a href="#estimating-the-late-of-401k-participation-on-net-financial-assets" id="toc-estimating-the-late-of-401k-participation-on-net-financial-assets" class="nav-link" data-scroll-target="#estimating-the-late-of-401k-participation-on-net-financial-assets">Estimating the LATE of 401(k) Participation on Net Financial Assets</a>
  <ul class="collapse">
  <li><a href="#partially-linear-iv-model" id="toc-partially-linear-iv-model" class="nav-link" data-scroll-target="#partially-linear-iv-model">Partially Linear IV Model</a></li>
  <li><a href="#interactive-iv-model" id="toc-interactive-iv-model" class="nav-link" data-scroll-target="#interactive-iv-model">Interactive IV Model</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Double/Debiased Machine Learning for Treatment and Structural Parameters</h1>
<p class="subtitle lead">V. Chernozhukov, D. Chetverikov, M. Demirer, E. Duflo, C. Hansen, W. Newey, J. Robins</p>
  <div class="quarto-categories">
    <div class="quarto-category">ML</div>
    <div class="quarto-category">Causal Inference</div>
  </div>
  </div>

<div>
  <div class="description">
    Obtain valid inferential statements about a low-dimensional parameter (ATE/LATE) in the presence of potentially high-dimensional confounding using modern ML methods.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 23, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell">
<style type="text/css">
.justify {
  text-align: justify !important
}
</style>
</div>
<div class="justify">
<p>Double/Debiased Machine Learning, proposed by <a href="https://academic.oup.com/ectj/article/21/1/C1/5056401">Chernozhukov et al.</a>, tackles the problem of inference on some parameter, <span class="math inline">\(\theta_0\)</span>, in the setting where there is a potentially high-dimensional set of control variables/confounders. To do so, this method harnesses generic ML algorithms which perform well in high-dimensional settings. DML can be applied to learn the ATE and LATE in a partially linear regression model and partially linear instrumental variables model, respectively. It can also be used to estimate the ATE and LATE in the interactive model and interactive instrumental variables model, where treatment effects are fully heterogeneous.</p>
<p>This post is going to show how to implement estimation of the ATE and LATE in both the partially linear and interactive settings. This will be a pretty minimal prototype, implemented entirely in base R. I’ll use a couple other packages for the ML methods, but which models you choose to use are entirely separate from the general method outlined here.</p>
</div>
<section id="packages" class="level2">
<h2 class="anchored" data-anchor-id="packages">Packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hdm)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<div class="justify">
<p>For clarity, we’ll use one of the same <a href="https://academic.oup.com/ectj/article/21/1/C1/5056401#130274213">empirical examples</a> used in the actual paper. This example is described as follows:</p>
<blockquote class="blockquote">
<p>We use the DML method to estimate the effect of 401(k) eligibility, the treatment variable, and 401(k) participation, a self‐selected decision to receive the treatment that we instrument for with assignment to the treatment state, on accumulated assets. In this example, the treatment variable is not randomly assigned and we aim to eliminate the potential biases due to the lack of random assignment by flexibly controlling for a rich set of variables.</p>
</blockquote>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(pension)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pension <span class="ot">&lt;-</span> pension[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pension), <span class="fu">nrow</span>(pension)), ]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct model inputs</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>form <span class="ot">&lt;-</span> <span class="er">~</span> (</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly</span>(age, <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">poly</span>(inc, <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">poly</span>(educ, <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">poly</span>(fsize,<span class="dv">2</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">as.factor</span>(marr) <span class="sc">+</span> <span class="fu">as.factor</span>(twoearn) <span class="sc">+</span> <span class="fu">as.factor</span>(db) <span class="sc">+</span> <span class="fu">as.factor</span>(pira)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">as.factor</span>(hown)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(form, <span class="at">data =</span> pension)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>X_RF <span class="ot">&lt;-</span> pension[, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"inc"</span>, <span class="st">"fsize"</span>, <span class="st">"educ"</span>, <span class="st">"db"</span>, <span class="st">"marr"</span>, <span class="st">"twoearn"</span>, <span class="st">"pira"</span>, <span class="st">"hown"</span>)]</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> pension<span class="sc">$</span>e401</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> pension<span class="sc">$</span>net_tfa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="justify">
<p>Now, let’s define a few simple functions for applying three different ML models (Random Forest, LASSO, and ElasticNet with <span class="math inline">\(\alpha = 0.5\)</span>) to our data. These three models will be used across each of the four DML estimation strategies.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># LASSO learner and prediction functions</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>y_learner_lasso <span class="ot">&lt;-</span> \(x, y) <span class="fu">cv.glmnet</span>(x, y, <span class="at">nfolds =</span> <span class="dv">5</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>d_learner_lasso <span class="ot">&lt;-</span> \(x, y) <span class="fu">cv.glmnet</span>(x, y, <span class="at">nfolds =</span> <span class="dv">5</span>, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>pred_fn_lasso <span class="ot">&lt;-</span> \(mod, data) <span class="fu">predict</span>(mod, data,<span class="st">"lambda.min"</span>, <span class="st">"response"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ElasticNet learner and prediction functions</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>y_learner_enet <span class="ot">&lt;-</span> \(x, y) <span class="fu">cv.glmnet</span>(x, y, <span class="at">nfolds =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>d_learner_enet <span class="ot">&lt;-</span> \(x, y) <span class="fu">cv.glmnet</span>(x, y, <span class="at">nfolds =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>pred_fn_enet <span class="ot">&lt;-</span> \(mod, data) <span class="fu">predict</span>(mod, data, <span class="st">"lambda.min"</span>, <span class="st">"response"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Random Forest learner and prediction functions</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>y_learner_rf <span class="ot">&lt;-</span> \(x, y) <span class="fu">ranger</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">num.trees =</span> <span class="dv">1000</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>d_learner_rf <span class="ot">&lt;-</span> \(x, y) <span class="fu">ranger</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">num.trees =</span> <span class="dv">1000</span>, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>pred_fn_rf_y <span class="ot">&lt;-</span> \(mod, data) <span class="fu">predict</span>(mod, data)<span class="sc">$</span>predictions</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>pred_fn_rf_d <span class="ot">&lt;-</span> \(mod, data) <span class="fu">predict</span>(mod, data)<span class="sc">$</span>predictions[, <span class="st">"1"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="estimating-the-ate-of-401k-eligibility-on-net-financial-assets" class="level2">
<h2 class="anchored" data-anchor-id="estimating-the-ate-of-401k-eligibility-on-net-financial-assets">Estimating the ATE of 401(k) Eligibility on Net Financial Assets</h2>
<div class="justify">
<blockquote class="blockquote">
<p>In the example in this paper, we use the same data as in <a href="http://dx.doi.org/10.1162/0034653041811734">Chernozhukov and Hansen (2004)</a>. We use net financial assets – defined as the sum of IRA balances, 401(k) balances, checking accounts, US saving bonds, other interest‐earning accounts in banks and other financial institutions, other interest‐earning assets (such as bonds held personally), stocks, and mutual funds less non‐mortgage debt – as the outcome variable, Y, in our analysis. Our treatment variable, D, is an indicator for being eligible to enroll in a 401(k) plan. The vector of raw covariates, X, consists of age, income, family size, years of education, a married indicator, a two‐earner status indicator, a defined benefit pension status indicator, an IRA participation indicator, and a home‐ownership indicator.</p>
</blockquote>
</div>
<section id="partially-linear-regression-model" class="level3">
<h3 class="anchored" data-anchor-id="partially-linear-regression-model">Partially Linear Regression Model</h3>
<div class="justify">
<p>First we will calculate the ATE of 401(k) eligibility on net financial assets in the partially linear model.</p>
<p>The following function implements DML for the partially linear model.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dml_plm <span class="ot">&lt;-</span> <span class="cf">function</span>(X, Y, D, y_learner, d_learner, pred_fn_y, <span class="at">pred_fn_d =</span> pred_fn_y) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create folds for sample splitting</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  fold1 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), <span class="at">size =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span><span class="fu">nrow</span>(X)))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  fold2 <span class="ot">&lt;-</span> <span class="fu">sample</span>((<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span>fold1], <span class="at">size =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span><span class="fu">nrow</span>(X)))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  fold3 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span><span class="fu">c</span>(fold1, fold2)]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create data.frame to store residuals</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  resids <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate outcome model across folds</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (fold <span class="cf">in</span> <span class="fu">list</span>(fold1, fold2, fold3)) {</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the training/prediction indices</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    idx_train <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span>fold]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    idx_predict <span class="ot">&lt;-</span> fold</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome prediction model</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    outcome_model <span class="ot">&lt;-</span> <span class="fu">y_learner</span>(</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> X[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Y[idx_train]</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residualize outcome</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    outcome_predictions <span class="ot">&lt;-</span> <span class="fu">pred_fn_y</span>(outcome_model, X[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    outcome_resids <span class="ot">&lt;-</span> Y[idx_predict] <span class="sc">-</span> outcome_predictions</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment prediction model</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    treatment_model <span class="ot">&lt;-</span> <span class="fu">d_learner</span>(</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> X[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> D[idx_train]</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residualize treatment</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    treatment_predictions <span class="ot">&lt;-</span> <span class="fu">pred_fn_d</span>(treatment_model, X[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    treatment_predictions <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(treatment_predictions, <span class="fl">0.01</span>), .<span class="dv">99</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    treatment_resids <span class="ot">&lt;-</span> (</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># This is necessary to deal with cases where D is a factor</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(D[idx_predict])) <span class="sc">-</span> treatment_predictions</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collect residuals</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    new_resids <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(outcome_resids),</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>      <span class="st">"d_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(treatment_resids),</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(outcome_predictions),</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>      <span class="st">"d_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(treatment_predictions),</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>      <span class="st">"idx"</span> <span class="ot">=</span> idx_predict</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    resids <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">list</span>(resids, new_resids))</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return data in original ordering</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(resids[<span class="fu">order</span>(resids[, <span class="st">"idx"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>]), , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="justify">
<p>Now that we’ve defined the function, let’s estimate the ATE using our three different ML methods.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate DML first stage</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>first_stage_lasso <span class="ot">&lt;-</span> <span class="fu">dml_plm</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_lasso,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_lasso,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_lasso</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>first_stage_enet <span class="ot">&lt;-</span> <span class="fu">dml_plm</span>(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_enet,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_enet,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_enet</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>first_stage_rf <span class="ot">&lt;-</span> <span class="fu">dml_plm</span>(</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X_RF,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="fu">factor</span>(D),</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_rf,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_rf,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_rf_y,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_d =</span> pred_fn_rf_d</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the ATE using OLS</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>ate_lasso <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(y_resid <span class="sc">~</span> d_resid, first_stage_lasso, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>ate_enet <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(y_resid <span class="sc">~</span> d_resid, first_stage_enet, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>ate_rf <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(y_resid <span class="sc">~</span> d_resid, first_stage_rf, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">LASSO</th>
<th style="text-align: right;">ElasticNet</th>
<th style="text-align: right;">RandomForest</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimate</td>
<td style="text-align: right;">9738.496</td>
<td style="text-align: right;">9816.064</td>
<td style="text-align: right;">8986.493</td>
</tr>
<tr class="even">
<td style="text-align: left;">Std. Error</td>
<td style="text-align: right;">1372.968</td>
<td style="text-align: right;">1412.982</td>
<td style="text-align: right;">1274.455</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RMSE Y</td>
<td style="text-align: right;">53255.882</td>
<td style="text-align: right;">53939.421</td>
<td style="text-align: right;">54589.826</td>
</tr>
<tr class="even">
<td style="text-align: left;">RMSE D</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">0.447</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="interactive-regression-model" class="level3">
<h3 class="anchored" data-anchor-id="interactive-regression-model">Interactive Regression Model</h3>
<div class="justify">
<p>Now, we’ll define the function to estimate the ATE in the fully heterogeneous model.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dml_irm <span class="ot">&lt;-</span> <span class="cf">function</span>(X,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                    Y,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                    D,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                    y_learner,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                    d_learner,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                    pred_fn_y,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pred_fn_d =</span> pred_fn_y) {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create folds for sample splitting</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  fold1 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), <span class="at">size =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span><span class="fu">nrow</span>(X)))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  fold2 <span class="ot">&lt;-</span> <span class="fu">sample</span>((<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span>fold1], <span class="at">size =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span><span class="fu">nrow</span>(X)))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  fold3 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span><span class="fu">c</span>(fold1, fold2)]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create data.frame to store residuals</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  resids <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate outcome model across folds</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (fold <span class="cf">in</span> <span class="fu">list</span>(fold1, fold2, fold3)) {</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the training/prediction indices</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    idx_train <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span>fold]</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    idx_predict <span class="ot">&lt;-</span> fold</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    numD <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(D))</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment prediction model</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    treatment_model <span class="ot">&lt;-</span> <span class="fu">d_learner</span>(</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> X[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> D[idx_train]</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residualize treatment</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    treatment_predictions <span class="ot">&lt;-</span> <span class="fu">pred_fn_d</span>(treatment_model, X[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    treatment_predictions <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(treatment_predictions, <span class="fl">0.01</span>), .<span class="dv">99</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    treatment_resids <span class="ot">&lt;-</span> (numD[idx_predict] <span class="sc">-</span> treatment_predictions)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome prediction model</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    XD <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">"D"</span> <span class="ot">=</span> numD, X)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    outcome_model <span class="ot">&lt;-</span> <span class="fu">y_learner</span>(</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> XD[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Y[idx_train]</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome predictions under control</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    XD[, <span class="st">"D"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    outcome_preds_d0 <span class="ot">&lt;-</span> <span class="fu">pred_fn_y</span>(outcome_model, XD[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome predictions under treatment</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    XD[, <span class="st">"D"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    outcome_preds_d1 <span class="ot">&lt;-</span> <span class="fu">pred_fn_y</span>(outcome_model, XD[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    outcome_predictions <span class="ot">&lt;-</span> (</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>      numD[idx_predict]<span class="sc">*</span>outcome_preds_d1</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>      <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> numD[idx_predict])<span class="sc">*</span>outcome_preds_d0</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate individual level weights</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    outcome_resids <span class="ot">&lt;-</span> Y[idx_predict] <span class="sc">-</span> outcome_predictions</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    inv_prop_scores <span class="ot">&lt;-</span> (</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>      numD[idx_predict]<span class="sc">/</span>treatment_predictions</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> numD[idx_predict])<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> treatment_predictions)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    expected_diff <span class="ot">&lt;-</span> outcome_preds_d1 <span class="sc">-</span> outcome_preds_d0</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    effect_estimates <span class="ot">&lt;-</span> expected_diff <span class="sc">+</span> inv_prop_scores<span class="sc">*</span>outcome_resids</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collect residuals</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    new_resids <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>      <span class="st">"effect_estimates"</span> <span class="ot">=</span> <span class="fu">unname</span>(effect_estimates),</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(outcome_resids),</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>      <span class="st">"d_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(treatment_resids),</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(outcome_predictions),</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>      <span class="st">"d_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(treatment_predictions),</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>      <span class="st">"idx"</span> <span class="ot">=</span> idx_predict</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    resids <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">list</span>(resids, new_resids))</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return data in original ordering</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(resids[<span class="fu">order</span>(resids[, <span class="st">"idx"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>]), , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s estimate the ATE!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate DML first stage</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>first_stage_lasso <span class="ot">&lt;-</span> <span class="fu">dml_irm</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_lasso,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_lasso,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_lasso</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>first_stage_enet <span class="ot">&lt;-</span> <span class="fu">dml_irm</span>(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_enet,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_enet,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_enet</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>first_stage_rf <span class="ot">&lt;-</span> <span class="fu">dml_irm</span>(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X_RF,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="fu">factor</span>(D),</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_rf,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_rf,</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_rf_y,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_d =</span> pred_fn_rf_d</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the ATE using OLS</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>ate_lasso <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(effect_estimates <span class="sc">~</span> <span class="dv">1</span>, first_stage_lasso, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>ate_enet <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(effect_estimates <span class="sc">~</span> <span class="dv">1</span>, first_stage_enet, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>ate_rf <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(effect_estimates <span class="sc">~</span> <span class="dv">1</span>, first_stage_rf, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">LASSO</th>
<th style="text-align: right;">ElasticNet</th>
<th style="text-align: right;">RandomForest</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimate</td>
<td style="text-align: right;">9078.850</td>
<td style="text-align: right;">9311.623</td>
<td style="text-align: right;">8100.171</td>
</tr>
<tr class="even">
<td style="text-align: left;">Std. Error</td>
<td style="text-align: right;">1412.741</td>
<td style="text-align: right;">1462.927</td>
<td style="text-align: right;">1149.504</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RMSE Y</td>
<td style="text-align: right;">53085.113</td>
<td style="text-align: right;">53732.086</td>
<td style="text-align: right;">54427.880</td>
</tr>
<tr class="even">
<td style="text-align: left;">RMSE D</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">0.447</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="estimating-the-late-of-401k-participation-on-net-financial-assets" class="level2">
<h2 class="anchored" data-anchor-id="estimating-the-late-of-401k-participation-on-net-financial-assets">Estimating the LATE of 401(k) Participation on Net Financial Assets</h2>
<div class="justify">
<p>We now will estimate the LATE of 401(k) participation on net financial assets, using 401(k) eligibility as our instrument and 401(k) participation as our treatment.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> pension<span class="sc">$</span>p401</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> pension<span class="sc">$</span>e401</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="partially-linear-iv-model" class="level3">
<h3 class="anchored" data-anchor-id="partially-linear-iv-model">Partially Linear IV Model</h3>
<div class="justify">
<p>The following function estimates the partially linear IV model.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dml_plivm <span class="ot">&lt;-</span> <span class="cf">function</span>(X,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                      Y,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                      D,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                      Z,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                      y_learner,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                      d_learner,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">z_learner =</span> d_learner,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                      pred_fn_y,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">pred_fn_d =</span> pred_fn_y,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">pred_fn_z =</span> pred_fn_d) {</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create folds for sample splitting</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  fold1 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), <span class="at">size =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span><span class="fu">nrow</span>(X)))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  fold2 <span class="ot">&lt;-</span> <span class="fu">sample</span>((<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span>fold1], <span class="at">size =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span><span class="fu">nrow</span>(X)))</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  fold3 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span><span class="fu">c</span>(fold1, fold2)]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create data.frame to store residuals</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  resids <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate outcome model across folds</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (fold <span class="cf">in</span> <span class="fu">list</span>(fold1, fold2, fold3)) {</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the training/prediction indices</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    idx_train <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span>fold]</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    idx_predict <span class="ot">&lt;-</span> fold</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert treatment and instrument to numeric</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    numD <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(D[idx_predict]))</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    numZ <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(Z[idx_predict]))</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome prediction model</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    outcome_model <span class="ot">&lt;-</span> <span class="fu">y_learner</span>(</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> X[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Y[idx_train]</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residualize outcome</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    outcome_predictions <span class="ot">&lt;-</span> <span class="fu">pred_fn_y</span>(outcome_model, X[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    outcome_resids <span class="ot">&lt;-</span> Y[idx_predict] <span class="sc">-</span> outcome_predictions</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment prediction model</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    treatment_model <span class="ot">&lt;-</span> <span class="fu">d_learner</span>(</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> X[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> D[idx_train]</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residualize treatment</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    treatment_predictions <span class="ot">&lt;-</span> <span class="fu">pred_fn_d</span>(treatment_model, X[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    treatment_resids <span class="ot">&lt;-</span> numD <span class="sc">-</span> treatment_predictions</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instrument prediction model</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    instrument_model <span class="ot">&lt;-</span> <span class="fu">z_learner</span>(</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> X[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Z[idx_train]</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residualize instrument</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    instrument_predictions <span class="ot">&lt;-</span> <span class="fu">pred_fn_z</span>(instrument_model, X[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    instrument_predictions <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(instrument_predictions, <span class="fl">0.01</span>), .<span class="dv">99</span>)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    instrument_resids <span class="ot">&lt;-</span> numZ <span class="sc">-</span> instrument_predictions</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collect residuals</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    new_resids <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(outcome_resids),</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>      <span class="st">"d_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(treatment_resids),</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(instrument_resids),</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(outcome_predictions),</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>      <span class="st">"d_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(treatment_predictions),</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(instrument_predictions),</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>      <span class="st">"idx"</span> <span class="ot">=</span> idx_predict</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    resids <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">list</span>(resids, new_resids))</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return data in original ordering</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(resids[<span class="fu">order</span>(resids[, <span class="st">"idx"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>]), , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s estimate the LATE now!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate DML first stage</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>first_stage_lasso <span class="ot">&lt;-</span> <span class="fu">dml_plivm</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_lasso,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_lasso,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_lasso</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>first_stage_enet <span class="ot">&lt;-</span> <span class="fu">dml_plivm</span>(</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_enet,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_enet,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_enet</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>first_stage_rf <span class="ot">&lt;-</span> <span class="fu">dml_plivm</span>(</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X_RF,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="fu">factor</span>(D),</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> <span class="fu">factor</span>(Z),</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_rf,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_rf,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_rf_y,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_d =</span> pred_fn_rf_d</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co"># TSLS with LASSO residuals</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>d_hat_lasso <span class="ot">&lt;-</span> <span class="fu">lm</span>(d_resid <span class="sc">~</span> z_resid, first_stage_lasso)<span class="sc">$</span>fitted.values</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>ate_lasso <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(first_stage_lasso<span class="sc">$</span>y_resid <span class="sc">~</span> d_hat_lasso, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="co"># TSLS with LASSO residuals</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>d_hat_enet <span class="ot">&lt;-</span> <span class="fu">lm</span>(d_resid <span class="sc">~</span> z_resid, first_stage_enet)<span class="sc">$</span>fitted.values</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>ate_enet <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(first_stage_enet<span class="sc">$</span>y_resid <span class="sc">~</span> d_hat_enet, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="co"># TSLS with RF residuals</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>d_hat_rf <span class="ot">&lt;-</span> <span class="fu">lm</span>(d_resid <span class="sc">~</span> z_resid, first_stage_rf)<span class="sc">$</span>fitted.values</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>ate_rf <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(first_stage_rf<span class="sc">$</span>y_resid <span class="sc">~</span> d_hat_rf, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">LASSO</th>
<th style="text-align: right;">ElasticNet</th>
<th style="text-align: right;">RandomForest</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimate</td>
<td style="text-align: right;">13982.593</td>
<td style="text-align: right;">13809.441</td>
<td style="text-align: right;">12781.930</td>
</tr>
<tr class="even">
<td style="text-align: left;">Std. Error</td>
<td style="text-align: right;">1980.323</td>
<td style="text-align: right;">1977.618</td>
<td style="text-align: right;">1938.429</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RMSE Y</td>
<td style="text-align: right;">53280.924</td>
<td style="text-align: right;">53123.786</td>
<td style="text-align: right;">56275.848</td>
</tr>
<tr class="even">
<td style="text-align: left;">RMSE D</td>
<td style="text-align: right;">0.415</td>
<td style="text-align: right;">0.414</td>
<td style="text-align: right;">0.418</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RMSE Z</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">0.449</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="interactive-iv-model" class="level3">
<h3 class="anchored" data-anchor-id="interactive-iv-model">Interactive IV Model</h3>
<div class="justify">
<p>Finally, the following function estimates the interactive IV model.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dml_iivm <span class="ot">&lt;-</span> <span class="cf">function</span>(X,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                     Y,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                     D,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                     Z,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                     y_learner,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                     d_learner,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">z_learner =</span> d_learner,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                     pred_fn_y,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pred_fn_d =</span> pred_fn_y,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pred_fn_z =</span> pred_fn_d,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">always_takers =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">never_takers =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create folds for sample splitting</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  fold1 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), <span class="at">size =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span><span class="fu">nrow</span>(X)))</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  fold2 <span class="ot">&lt;-</span> <span class="fu">sample</span>((<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span>fold1], <span class="at">size =</span> <span class="fu">round</span>((<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">*</span><span class="fu">nrow</span>(X)))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  fold3 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span><span class="fu">c</span>(fold1, fold2)]</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create data.frame to store residuals</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  resids <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate outcome model across folds</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (fold <span class="cf">in</span> <span class="fu">list</span>(fold1, fold2, fold3)) {</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the training/prediction indices</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    idx_train <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X))[<span class="sc">-</span>fold]</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    idx_predict <span class="ot">&lt;-</span> fold</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert treatment and instrument to numeric</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    numD <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(D))</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    numZ <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(Z))</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome model</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    XZ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">"Z"</span> <span class="ot">=</span> numZ, X)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    outcome_model <span class="ot">&lt;-</span> <span class="fu">y_learner</span>(</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> XZ[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Y[idx_train]</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome predictions under Instrument == 0</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    XZ[, <span class="st">"Z"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    outcome_preds_z0 <span class="ot">&lt;-</span> <span class="fu">pred_fn_y</span>(outcome_model, XZ[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome predictions under Instrument == 1</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    XZ[, <span class="st">"Z"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    outcome_preds_z1 <span class="ot">&lt;-</span> <span class="fu">pred_fn_y</span>(outcome_model, XZ[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome predictions and residuals</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    outcome_predictions <span class="ot">&lt;-</span> (</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>      numZ[idx_predict]<span class="sc">*</span>outcome_preds_z1</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>      <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> numZ[idx_predict])<span class="sc">*</span>outcome_preds_z0</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    outcome_resids <span class="ot">&lt;-</span> Y[idx_predict] <span class="sc">-</span> outcome_predictions</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment model</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    XZ <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">"Z"</span> <span class="ot">=</span> numZ, X)</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    treatment_model <span class="ot">&lt;-</span> <span class="fu">d_learner</span>(</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> XZ[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> D[idx_train]</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment predictions under Instrument == 0</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (always_takers <span class="sc">==</span> <span class="cn">FALSE</span>) {</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>      treatment_preds_z0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(D[idx_predict]))</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>      XZ[, <span class="st">"Z"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>      treatment_preds_z0 <span class="ot">&lt;-</span> <span class="fu">pred_fn_d</span>(treatment_model, XZ[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment predictions under Instrument == 1</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (never_takers <span class="sc">==</span> <span class="cn">FALSE</span>) {</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>      treatment_preds_z1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(D[idx_predict]))</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>      XZ[, <span class="st">"Z"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>      treatment_preds_z1 <span class="ot">&lt;-</span> <span class="fu">pred_fn_d</span>(treatment_model, XZ[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment predictions and residuals</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>    treatment_predictions <span class="ot">&lt;-</span> (</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>      numZ[idx_predict]<span class="sc">*</span>treatment_preds_z1</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>      <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> numZ[idx_predict])<span class="sc">*</span>treatment_preds_z0</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    treatment_resids <span class="ot">&lt;-</span> numD[idx_predict] <span class="sc">-</span> treatment_predictions</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instrument prediction model</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    instrument_model <span class="ot">&lt;-</span> <span class="fu">z_learner</span>(</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> X[idx_train, , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Z[idx_train]</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instrument predictions and residuals</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    instrument_predictions <span class="ot">&lt;-</span> <span class="fu">pred_fn_z</span>(instrument_model, X[idx_predict, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    treatment_predictions <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(treatment_predictions, <span class="fl">0.01</span>), .<span class="dv">99</span>)</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    instrument_resids <span class="ot">&lt;-</span> numZ[idx_predict] <span class="sc">-</span> instrument_predictions</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct effect estimates</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>    effect_estimates <span class="ot">&lt;-</span> (</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>      (outcome_preds_z1 <span class="sc">-</span> outcome_preds_z0)</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>      <span class="sc">+</span> (numZ[idx_predict]<span class="sc">*</span>(Y[idx_predict] <span class="sc">-</span> outcome_preds_z1))</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>        <span class="sc">/</span>instrument_predictions</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> ((<span class="dv">1</span> <span class="sc">-</span> numZ[idx_predict])<span class="sc">*</span>(Y[idx_predict] <span class="sc">-</span> outcome_preds_z0))</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>        <span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> instrument_predictions)</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> (</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>        (treatment_preds_z1 <span class="sc">-</span> treatment_preds_z0)</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>        <span class="sc">+</span> (numZ[idx_predict]<span class="sc">*</span>(numD[idx_predict] <span class="sc">-</span> treatment_preds_z1))</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>          <span class="sc">/</span>instrument_predictions</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span> ((<span class="dv">1</span> <span class="sc">-</span> numZ[idx_predict])<span class="sc">*</span>(numD[idx_predict] <span class="sc">-</span> treatment_preds_z0))</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>          <span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> instrument_predictions)</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collect residuals</span></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    new_resids <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>      <span class="st">"effect_estimates"</span> <span class="ot">=</span> <span class="fu">unname</span>(effect_estimates),</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(outcome_resids),</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>      <span class="st">"d_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(treatment_resids),</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z_resid"</span> <span class="ot">=</span> <span class="fu">unname</span>(instrument_resids),</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(outcome_predictions),</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>      <span class="st">"d_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(treatment_predictions),</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z_hat"</span> <span class="ot">=</span> <span class="fu">unname</span>(instrument_predictions),</span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>      <span class="st">"idx"</span> <span class="ot">=</span> idx_predict</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>    resids <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">list</span>(resids, new_resids))</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return data in original ordering</span></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(resids[<span class="fu">order</span>(resids[, <span class="st">"idx"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>]), , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s estimate the LATE now!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate DML first stage</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>first_stage_lasso <span class="ot">&lt;-</span> <span class="fu">dml_iivm</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_lasso,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_lasso,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_lasso,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">always_takers =</span> <span class="cn">FALSE</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>first_stage_enet <span class="ot">&lt;-</span> <span class="fu">dml_iivm</span>(</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_enet,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_enet,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_enet,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">always_takers =</span> <span class="cn">FALSE</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>first_stage_rf <span class="ot">&lt;-</span> <span class="fu">dml_iivm</span>(</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X_RF,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="fu">factor</span>(D),</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> <span class="fu">factor</span>(Z),</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_learner =</span> y_learner_rf,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_learner =</span> d_learner_rf,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_y =</span> pred_fn_rf_y,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_fn_d =</span> pred_fn_rf_d,</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">always_takers =</span> <span class="cn">FALSE</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ATEs</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>ate_lasso <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(first_stage_lasso<span class="sc">$</span>effect_estimates <span class="sc">~</span> <span class="dv">1</span>, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>ate_enet <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(first_stage_enet<span class="sc">$</span>effect_estimates <span class="sc">~</span> <span class="dv">1</span>, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>ate_rf <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(first_stage_rf<span class="sc">$</span>effect_estimates <span class="sc">~</span> <span class="dv">1</span>, <span class="at">se_type =</span> <span class="st">"HC1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">LASSO</th>
<th style="text-align: right;">ElasticNet</th>
<th style="text-align: right;">RandomForest</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimate</td>
<td style="text-align: right;">9155.272</td>
<td style="text-align: right;">8686.631</td>
<td style="text-align: right;">7687.822</td>
</tr>
<tr class="even">
<td style="text-align: left;">Std. Error</td>
<td style="text-align: right;">1458.567</td>
<td style="text-align: right;">1323.662</td>
<td style="text-align: right;">1213.721</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RMSE Y</td>
<td style="text-align: right;">53083.322</td>
<td style="text-align: right;">52912.153</td>
<td style="text-align: right;">55839.966</td>
</tr>
<tr class="even">
<td style="text-align: left;">RMSE D</td>
<td style="text-align: right;">0.275</td>
<td style="text-align: right;">0.275</td>
<td style="text-align: right;">0.277</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RMSE Z</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">0.449</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<div class="justify">
<p>And that’s it! There are some additional tidbits, for example estimating the ATTE instead of the ATE, estimating confidence intervals with a multiplier bootstrap, and dealing with multiple treatments, but this has covered (IMO) the essentials. This really helped me solidify the underlying estimation strategy, which I found very helpful.</p>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>